async function getBlogPosts(){try{return await getBlogPostsFromFirebase()}catch(e){return console.error("Error loading blog posts:",e),[]}}async function getPostViews(e){try{const t=await getPostStatsFromFirebase(e);return t?.views||0}catch(e){return console.error("Error getting views:",e),0}}async function incrementPostViews(e){try{return await incrementPostViewsInFirebase(e),await getPostViews(e)}catch(e){return console.error("Error incrementing views:",e),0}}async function getPostLikes(e){try{const t=await getPostStatsFromFirebase(e);return t?.likes||0}catch(e){return console.error("Error getting likes:",e),0}}function isPostLiked(e){const t=localStorage.getItem("userLikes");return(t?JSON.parse(t):[]).includes(e)}async function toggleLike(e){const t=localStorage.getItem("userLikes"),n=t?JSON.parse(t):[],o=n.includes(e);try{if(o){await incrementPostLikesInFirebase(e,-1);const t=n.indexOf(e);n.splice(t,1)}else await incrementPostLikesInFirebase(e,1),n.push(e);return localStorage.setItem("userLikes",JSON.stringify(n)),!o}catch(e){return console.error("Error toggling like:",e),o}}async function loadComments(e){try{const t=await getCommentsFromFirebase(e);await displayComments(t,e)}catch(e){console.error("Error loading comments:",e),document.getElementById("comments-list").innerHTML='<p style="color: #999; text-align: center;">Error loading comments</p>'}}async function displayComments(e,t){const n=document.getElementById("comments-list");if(!e||0===e.length)return void(n.innerHTML='<p style="color: #999; text-align: center; padding: 2rem;">No comments yet. Be the first to comment!</p>');const o=e.filter(e=>!e.parentId),i=e.filter(e=>e.parentId),r=o.sort((e,t)=>{const n=(e.likes||0)-(e.dislikes||0);return(t.likes||0)-(t.dislikes||0)-n}),s=r.slice(0,10),a=r.length-10,l=s.map(async e=>{const n=i.filter(t=>t.parentId===(e.id||e.timestamp));return await renderComment(e,t,n)}),c=await Promise.all(l);n.innerHTML=c.join(""),a>0&&(n.innerHTML+=`\n            <div style="text-align: center; padding: 2rem;">\n                <button onclick="loadMoreComments('${t}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem;">\n                    Load More Comments (${a})\n                </button>\n            </div>\n        `),window.allComments=r,window.allReplies=i,window.currentCommentIndex=10}async function renderComment(e,t,n=[]){const o=e.name.charAt(0).toUpperCase(),i=e.id||e.timestamp,r=getTimeAgo(e.timestamp),s=n.sort((e,t)=>{const n=(e.likes||0)-(e.dislikes||0);return(t.likes||0)-(t.dislikes||0)-n}),a=s.slice(0,5),l=s.length-5,c=await getUserCommentInteractions(),d=c.likes||{},m=c.dislikes||{},p=a.map(e=>{const t=e.name.charAt(0).toUpperCase(),n=getTimeAgo(e.timestamp),o=e.id||e.timestamp,i=e.likes||0,r=e.dislikes||0,s=d[o],a=m[o];return`\n            <div class="comment comment-reply" data-comment-id="${o}">\n                <div class="comment-avatar">${t}</div>\n                <div class="comment-content">\n                    <div class="comment-bubble">\n                        <span class="comment-author">${e.name}</span>\n                        <div class="comment-body">${e.text}</div>\n                    </div>\n                    <div class="comment-meta">\n                        <span class="comment-date" title="${n.full}">${n.relative}</span>\n                        <div class="comment-actions">\n                            <button class="comment-action-btn ${s?"liked":""}" data-like="${o}">\n                                <span>üëç</span> <span>${i||""}</span>\n                            </button>\n                            <button class="comment-action-btn ${a?"disliked":""}" data-dislike="${o}">\n                                <span>üëé</span> <span>${r||""}</span>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `}).join(""),u=e.likes||0,g=e.dislikes||0,y=d[i],h=m[i],w=l>0?`\n        <div style="padding: 1rem 0 1rem 3rem;">\n            <button onclick="loadMoreReplies('${i}', '${t}')" style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.5rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">\n                Load More Replies (${l})\n            </button>\n        </div>\n    `:"";return`\n        <div class="comment-thread" data-thread-id="${i}">\n            <div class="comment" data-comment-id="${i}">\n                <div class="comment-avatar">${o}</div>\n                <div class="comment-content">\n                    <div class="comment-bubble">\n                        <span class="comment-author">${e.name}</span>\n                        <div class="comment-body">${e.text}</div>\n                    </div>\n                    <div class="comment-meta">\n                        <span class="comment-date" title="${r.full}">${r.relative}</span>\n                        <div class="comment-actions">\n                            <button class="comment-action-btn ${y?"liked":""}" data-like="${i}">\n                                <span>üëç</span> <span>${u||""}</span>\n                            </button>\n                            <button class="comment-action-btn ${h?"disliked":""}" data-dislike="${i}">\n                                <span>üëé</span> <span>${g||""}</span>\n                            </button>\n                            <button class="comment-action-btn" data-reply="${i}" data-author="${e.name}">\n                                <span>üí¨</span> Reply\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            <div class="reply-form-container" id="reply-${i}"></div>\n            ${p?`<div class="comment-replies" id="replies-${i}">${p}</div>`:""}\n            ${w}\n        </div>\n    `}function getTimeAgo(e){if(!e)return{relative:"Just now",full:"Just now"};const t=new Date(e),n=Date.now()-e,o=Math.floor(n/6e4),i=Math.floor(o/60),r=Math.floor(i/24),s=t.toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0});let a;return a=o<1?"Just now":o<60?`${o}m ago`:i<24?`${i}h ago`:r<7?`${r}d ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),{relative:a,full:s}}async function postComment(e,t,n,o=null){const i={name:t,text:n,postId:e,timestamp:Date.now(),parentId:o,likes:0,dislikes:0};try{return await saveCommentToFirebase(i),await loadComments(e),!0}catch(e){return console.error("Error posting comment:",e),!1}}async function loadMoreComments(e){const t=document.getElementById("comments-list"),n=window.allComments.slice(window.currentCommentIndex,window.currentCommentIndex+10),o=window.allComments.length-window.currentCommentIndex-10,i=t.querySelector('div[style*="text-align: center"]');i&&i.remove();for(const o of n){const n=window.allReplies.filter(e=>e.parentId===(o.id||o.timestamp)),i=await renderComment(o,e,n);t.innerHTML+=i}window.currentCommentIndex+=10,o>0&&(t.innerHTML+=`\n            <div style="text-align: center; padding: 2rem;">\n                <button onclick="loadMoreComments('${e}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem;">\n                    Load More Comments (${o})\n                </button>\n            </div>\n        `)}async function loadMoreReplies(e,t){const n=document.querySelector(`[data-thread-id="${e}"]`),o=n.querySelector(`#replies-${e}`),i=n.querySelector('div[style*="padding: 1rem 0 1rem 3rem"]'),r=window.allReplies.filter(t=>t.parentId===e).sort((e,t)=>{const n=(e.likes||0)-(e.dislikes||0);return(t.likes||0)-(t.dislikes||0)-n}),s=await getUserCommentInteractions(),a=s.likes||{},l=s.dislikes||{};r.slice(5).forEach(e=>{const t=e.name.charAt(0).toUpperCase(),n=getTimeAgo(e.timestamp),i=e.id||e.timestamp,r=e.likes||0,s=e.dislikes||0,c=a[i],d=l[i],m=`\n            <div class="comment comment-reply" data-comment-id="${i}">\n                <div class="comment-avatar">${t}</div>\n                <div class="comment-content">\n                    <div class="comment-bubble">\n                        <span class="comment-author">${e.name}</span>\n                        <div class="comment-body">${e.text}</div>\n                    </div>\n                    <div class="comment-meta">\n                        <span class="comment-date" title="${n.full}">${n.relative}</span>\n                        <div class="comment-actions">\n                            <button class="comment-action-btn ${c?"liked":""}" data-like="${i}">\n                                <span>üëç</span> <span>${r||""}</span>\n                            </button>\n                            <button class="comment-action-btn ${d?"disliked":""}" data-dislike="${i}">\n                                <span>üëé</span> <span>${s||""}</span>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;o.innerHTML+=m}),i&&i.remove()}function getUserSessionId(){let e=sessionStorage.getItem("userSessionId");return e||(e="user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),sessionStorage.setItem("userSessionId",e)),e}async function getUserCommentInteractions(){try{const e=getUserSessionId(),t=await db.collection("userInteractions").doc(e).get();return t.exists?t.data():{likes:{},dislikes:{}}}catch(e){return console.error("Error getting user interactions:",e),{likes:{},dislikes:{}}}}async function saveUserCommentInteractions(e){try{const t=getUserSessionId();await db.collection("userInteractions").doc(t).set(e)}catch(e){console.error("Error saving user interactions:",e)}}async function toggleCommentLike(e,t,n){try{const o=await getUserCommentInteractions(),i=o.likes||{},r=o.dislikes||{},s=(await getCommentsFromFirebase(e)).find(e=>String(e.id||e.timestamp)===String(t));s&&("like"===n?i[t]?(s.likes=Math.max(0,(s.likes||0)-1),delete i[t]):(s.likes=(s.likes||0)+1,i[t]=!0,r[t]&&(s.dislikes=Math.max(0,(s.dislikes||0)-1),delete r[t])):r[t]?(s.dislikes=Math.max(0,(s.dislikes||0)-1),delete r[t]):(s.dislikes=(s.dislikes||0)+1,r[t]=!0,i[t]&&(s.likes=Math.max(0,(s.likes||0)-1),delete i[t])),await saveUserCommentInteractions({likes:i,dislikes:r}),await saveCommentToFirebase(s),await loadComments(e))}catch(e){console.error("Error toggling like:",e)}}function setupCommentListeners(e){document.addEventListener("click",async t=>{const n=t.target.closest("[data-reply]"),o=t.target.closest("[data-like]"),i=t.target.closest("[data-dislike]");if(n){showReplyForm(n.dataset.reply,n.dataset.author,e)}if(o){const t=o.dataset.like;await toggleCommentLike(e,t,"like")}if(i){const t=i.dataset.dislike;await toggleCommentLike(e,t,"dislike")}});const t=document.getElementById("comment-form");t&&t.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("comment-name").value.trim(),o=document.getElementById("comment-text").value.trim();if(n&&o){await postComment(e,n,o)&&(document.getElementById("comment-text").value="")}})}function showReplyForm(e,t,n){document.querySelectorAll(".inline-reply-form").forEach(e=>e.remove());const o=document.getElementById(`reply-${e}`);if(!o)return;const i=document.getElementById("comment-name")?.value||"";o.innerHTML=`\n        <form class="inline-reply-form" style="padding: 1rem 0 1rem 3rem;">\n            <input type="text" class="reply-name" placeholder="Your name" value="${i}" style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 0.5rem;">\n            <textarea class="reply-text" placeholder="Write a reply..." style="width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 12px; min-height: 80px; margin-bottom: 0.5rem;"></textarea>\n            <div style="display: flex; gap: 0.5rem;">\n                <button type="submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Reply</button>\n                <button type="button" class="cancel-reply" style="background: transparent; color: #6b7280; border: 1px solid #e5e7eb; padding: 0.5rem 1.25rem; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>\n            </div>\n        </form>\n    `;const r=o.querySelector(".inline-reply-form");r.querySelector(".reply-name").focus(),r.addEventListener("submit",async t=>{t.preventDefault();const i=r.querySelector(".reply-name").value.trim(),s=r.querySelector(".reply-text").value.trim();if(i&&s){await postComment(n,i,s,e)&&(o.innerHTML="")}}),r.querySelector(".cancel-reply").addEventListener("click",()=>{o.innerHTML=""})}async function loadRelatedPosts(e){const t=await getBlogPosts(),n=document.getElementById("related-posts-grid"),o=t.filter(t=>t.id!==e&&!t.hidden).sort(()=>.5-Math.random()).slice(0,3);0!==o.length?n.innerHTML=o.map(e=>{const t=calculateReadingTime(e.content);return`\n            <a href="/blog/${e.id}" class="related-post-card">\n                <img src="${e.image}" alt="${e.title}" loading="lazy">\n                <div class="related-post-content">\n                    <div class="related-post-meta">${e.date} ‚Ä¢ ${t} min read</div>\n                    <h3>${e.title}</h3>\n                    <p>${e.excerpt}</p>\n                </div>\n            </a>\n        `}).join(""):n.innerHTML='<p style="text-align: center; color: var(--text-light);">No related posts available.</p>'}function getPostIdFromUrl(){const e=window.location.pathname.match(/\/blog\/([a-zA-Z0-9_-]+)/);if(e){const t=e[1];return isNaN(t)?t:parseInt(t)}const t=new URLSearchParams(window.location.search).get("id");return t?isNaN(t)?t:parseInt(t):null}window.loadMoreComments=loadMoreComments,window.loadMoreReplies=loadMoreReplies,document.addEventListener("DOMContentLoaded",async function(){const e=getPostIdFromUrl();if(!e)return void(window.location.href="/blog");const t=await getBlogPosts(),n=t.find(t=>t.id==e||t.id===e.toString()||t.id===parseInt(e)||parseInt(t.id)===e);if(!n)return console.error("Post not found. Looking for ID:",e),console.log("Available posts:",t.map(e=>({id:e.id,title:e.title}))),document.getElementById("post-title").textContent="Post Not Found",void(document.getElementById("post-content").innerHTML=`\n            <p>Sorry, this blog post could not be found.</p>\n            <p><strong>Requested ID:</strong> ${e}</p>\n            <p><a href="/blog">‚Üê Return to blog</a></p>\n        `);if(n.hidden)return document.getElementById("post-title").textContent="Post Not Available",void(document.getElementById("post-content").innerHTML='<p>This blog post is currently not available.</p><p><a href="/blog">‚Üê Return to blog</a></p>');document.title=`${n.title} | Garudhiya`;const o=document.getElementById("breadcrumb-current");o&&(o.textContent=n.title);const i=document.querySelector('meta[name="description"]');i&&(i.content=n.excerpt);const r=window.location.href;let s=document.querySelector('meta[property="og:title"]');s||(s=document.createElement("meta"),s.setAttribute("property","og:title"),document.head.appendChild(s)),s.content=n.title;let a=document.querySelector('meta[property="og:description"]');a||(a=document.createElement("meta"),a.setAttribute("property","og:description"),document.head.appendChild(a)),a.content=n.excerpt;let l=document.querySelector('meta[property="og:url"]');l||(l=document.createElement("meta"),l.setAttribute("property","og:url"),document.head.appendChild(l)),l.content=r;let c=document.querySelector('meta[property="og:image"]');c||(c=document.createElement("meta"),c.setAttribute("property","og:image"),document.head.appendChild(c)),c.content=n.image;let d=document.querySelector('meta[property="og:type"]');d||(d=document.createElement("meta"),d.setAttribute("property","og:type"),document.head.appendChild(d)),d.content="article";let m=document.querySelector('meta[property="twitter:card"]');m||(m=document.createElement("meta"),m.setAttribute("property","twitter:card"),document.head.appendChild(m)),m.content="summary_large_image";let p=document.querySelector('meta[property="twitter:title"]');p||(p=document.createElement("meta"),p.setAttribute("property","twitter:title"),document.head.appendChild(p)),p.content=n.title;let u=document.querySelector('meta[property="twitter:description"]');u||(u=document.createElement("meta"),u.setAttribute("property","twitter:description"),document.head.appendChild(u)),u.content=n.excerpt;let g=document.querySelector('meta[property="twitter:image"]');g||(g=document.createElement("meta"),g.setAttribute("property","twitter:image"),document.head.appendChild(g)),g.content=n.image;const y=n.content?n.content.trim().split(/\s+/).length:0,h=Math.ceil(y/200);document.getElementById("post-emoji").innerHTML=`<img src="${n.image}" alt="${n.title}" loading="lazy" style="max-width: 400px; width: 100%; height: auto; border-radius: 12px;">`;const w=`viewed_${e}`;sessionStorage.getItem(w)||(await incrementPostViews(e),sessionStorage.setItem(w,"true"));const b=await getPostViews(e);document.getElementById("post-title").textContent=n.title,document.getElementById("post-date").textContent=`${n.date} ‚Ä¢ ${h} min read ‚Ä¢ ${b} views`;const k=document.getElementById("post-content");if(n.content){if(/<[a-z][\s\S]*>/i.test(n.content))k.innerHTML=n.content;else{const e=n.content.split("\n\n").filter(e=>e.trim());k.innerHTML=e.map(e=>`<p>${e.trim()}</p>`).join("")}}else k.innerHTML=`\n            <p>${n.excerpt}</p>\n            <p><em>This is a preview. Full content coming soon!</em></p>\n        `;const v=document.getElementById("like-button"),f=document.getElementById("like-count"),$=v.querySelector(".heart-icon"),C=v.querySelector(".like-text"),I=await getPostLikes(e),x=isPostLiked(e);f.textContent=I,x&&(v.classList.add("liked"),$.textContent="‚ô•",C.textContent="Liked"),v.addEventListener("click",async function(){const t=await toggleLike(e),n=await getPostLikes(e);f.textContent=n,t?(v.classList.add("liked"),$.textContent="‚ô•",C.textContent="Liked","function"==typeof showToast&&showToast("Thanks for liking this post!","success")):(v.classList.remove("liked"),$.textContent="‚ô°",C.textContent="Like this post")});const L=window.location.href,E=encodeURIComponent(n.title),S=encodeURIComponent(L);document.getElementById("share-twitter").addEventListener("click",function(){window.open(`https://twitter.com/intent/tweet?text=${E}&url=${S}`,"_blank","width=600,height=400")}),document.getElementById("share-facebook").addEventListener("click",function(){window.open(`https://www.facebook.com/sharer/sharer.php?u=${S}`,"_blank","width=600,height=400")}),document.getElementById("share-linkedin").addEventListener("click",function(){window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${S}`,"_blank","width=600,height=400")}),document.getElementById("share-copy").addEventListener("click",function(){navigator.clipboard.writeText(L).then(function(){const e=document.getElementById("share-copy"),t=e.innerHTML;e.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!',setTimeout(function(){e.innerHTML=t},2e3)})}),await loadRelatedPosts(e),await loadComments(e),setupCommentListeners(e)});